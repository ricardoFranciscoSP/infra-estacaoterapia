{
	email contato@estacaoterapia.com.br
	admin 0.0.0.0:2019

	log {
		output stdout
		level INFO
	}
}

# ============================================
# API BACKEND
# ============================================
# ✅ CORRETO: API está em estacao-backend-network (rede externa do Swarm)
# Caddy (em docker-stack.caddy.yml) também está conectado nessa rede
# Docker Swarm cria VIP automático resolvido pelo DNS interno
api-prd.estacaoterapia.com.br {
	reverse_proxy estacaoterapia_api:3333 {
		# Testar saúde via /health endpoint
		health_uri /health
		health_interval 15s
		health_timeout 10s
		health_status 200

		transport http {
			dial_timeout 15s
			response_header_timeout 30s
			read_timeout 30s
		}
	}

	header {
		Access-Control-Allow-Origin "https://estacaoterapia.com.br https://www.estacaoterapia.com.br"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
		Access-Control-Allow-Credentials "true"
		Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"

		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "geolocation=(), microphone=(), camera=()"

		-Server
		-X-Powered-By
	}

	encode gzip zstd
}

# ============================================
# WEBSOCKET
# ============================================
# ✅ CORRETO: socket-server está em estacao-backend-network (rede externa do Swarm)
# Caddy pode resolver 'socket-server' via DNS VIP do Docker Swarm
ws.prd.estacaoterapia.com.br {
	reverse_proxy estacaoterapia_socket-server:3334 {
		health_uri /health
		health_interval 15s
		health_timeout 10s
		health_status 200

		transport http {
			dial_timeout 15s
			response_header_timeout 30s
			read_timeout 60s
		}

		# Importante para WebSockets
		header_up Upgrade websocket
		header_up Connection upgrade
	}

	header {
		Access-Control-Allow-Origin "https://estacaoterapia.com.br https://www.estacaoterapia.com.br"
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Credentials "true"
		Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"

		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"

		-Server
		-X-Powered-By
	}
}

# ============================================
# FRONTEND (Next.js)
# ============================================
# NOTA: Usar o nome do serviço + rede overlay externa
# O serviço está em: estacao-network (rede externa compartilhada)
estacaoterapia.com.br, www.estacaoterapia.com.br {
	reverse_proxy estacao_next_prd:3001 {
		transport http {
			dial_timeout 10s
			response_header_timeout 30s
		}
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "geolocation=(), microphone=(), camera=()"

		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api-prd.estacaoterapia.com.br https://ws.prd.estacaoterapia.com.br; frame-ancestors 'self';"

		-Server
		-X-Powered-By
	}

	encode gzip zstd

	@static_assets {
		path *.js *.css *.png *.jpg *.jpeg *.gif *.svg *.ico *.woff *.woff2 *.ttf *.eot
	}

	header @static_assets {
		Cache-Control "public, max-age=31536000, immutable"
	}
}
