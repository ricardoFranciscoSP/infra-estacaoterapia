{
	email contato@estacaoterapia.com.br
	# üîí Restringir admin √† localhost (ou remova se n√£o usar)
	admin 127.0.0.1:2019

	log {
		output stdout
		level INFO
	}
}

# ============================================
# API BACKEND
# ============================================
api-prd.estacaoterapia.com.br {
	# Tratar preflight CORS
	@options method OPTIONS
	handle @options {
		header {
			Access-Control-Allow-Origin "{http.request.header.Origin}"
			Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
			Access-Control-Allow-Credentials "true"
			Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
			Access-Control-Max-Age "86400"
		}
		respond 204
	}

	reverse_proxy estacaoterapia_api:3333 {
		health_uri /health
		health_interval 15s
		health_timeout 10s
		health_status 200

		transport http {
			dial_timeout 15s
			response_header_timeout 30s
			read_timeout 30s
		}
	}

	# Respostas normais (n√£o-OPTIONS)
	header {
		# Din√¢mico: reflete o Origin v√°lido
		@allowed_origin {
			header_regexp Origin ^https://(www\.)?estacaoterapia\.com\.br$
		}
		header @allowed_origin Access-Control-Allow-Origin "{http.request.header.Origin}"
		Access-Control-Allow-Credentials "true"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
		Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"

		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "geolocation=(), microphone=(), camera=()"

		-Server
		-X-Powered-By
	}

	encode gzip zstd
}

# ============================================
# WEBSOCKET
# ============================================
ws.prd.estacaoterapia.com.br, http://ws.prd.estacaoterapia.com.br  {
	@options method OPTIONS
	handle @options {
		header {
			Access-Control-Allow-Origin "{http.request.header.Origin}"
			Access-Control-Allow-Methods "GET, POST, OPTIONS"
			Access-Control-Allow-Credentials "true"
			Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
			Access-Control-Max-Age "86400"
		}
		respond 204
	}

	   reverse_proxy estacaoterapia_socket-server:3334 {
		   health_uri /health
		   health_interval 15s
		   health_timeout 10s
		   health_status 200

		   # For√ßa HTTP/1.1 para compatibilidade com Socket.IO
		   transport http {
			   versions 1.1
			   dial_timeout 15s
			   response_header_timeout 30s
			   read_timeout 60s
		   }

		   header_up Upgrade websocket
		   header_up Connection upgrade
	   }

	header {
		@allowed_origin {
			header_regexp Origin ^https://(www\.)?estacaoterapia\.com\.br$
		}
		header @allowed_origin Access-Control-Allow-Origin "{http.request.header.Origin}"
		Access-Control-Allow-Credentials "true"
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"

		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"

		-Server
		-X-Powered-By
	}
}

# ============================================
# FRONTEND (Next.js)
# ============================================
estacaoterapia.com.br, www.estacaoterapia.com.br {
	@socketio {
		path /socket.io*
	}
	handle @socketio {
		reverse_proxy estacaoterapia_socket-server:3334 {
			health_uri /health
			health_interval 15s
			health_timeout 10s
			health_status 200

			# For√ßa HTTP/1.1 para compatibilidade com Socket.IO
			transport http {
				versions 1.1
				dial_timeout 15s
				response_header_timeout 30s
				read_timeout 60s
			}

			header_up Upgrade websocket
			header_up Connection upgrade
		}
	}

	reverse_proxy estacao_estacao_next_prd:3001 {
		transport http {
			dial_timeout 10s
			response_header_timeout 30s
		}
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "geolocation=(), microphone=(), camera=()"
		# CSP √© definido no Next.js (next.config.ts)

		-Server
		-X-Powered-By
	}

	encode gzip zstd

	@static_assets {
		path *.js *.css *.png *.jpg *.jpeg *.gif *.svg *.ico *.woff *.woff2 *.ttf *.eot
	}
	
	header @static_assets {
		Cache-Control "public, max-age=31536000, immutable"
	}

	   # Removido: sobrescrita manual de Content-Type para evitar problemas de MIME type
	   # O Caddy j√° detecta corretamente os tipos de arquivos est√°ticos
	   # Mant√©m apenas o cache para assets
}